---
import PocketBase from 'pocketbase'
import Layout from '../layouts/Layout.astro'
import { SESSION_COOKIE_KEY } from '../config'

if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData()

    const pb = new PocketBase('http://127.0.0.1:8090')
    // pb.authStore.clear() // may not be necessary on server?

    const email = (data.get('email') ?? '') as string
    const password = (data.get('password') ?? '') as string

    await pb.collection('users').authWithPassword(email, password)

    const cookie = pb.authStore.exportToCookie()

    const [, session = '', expires = ''] =
      /^pb_auth=(.*?);.*?Expires=(.*?);/.exec(decodeURIComponent(cookie)) ?? []

    // console.log('cookie:', session)

    Astro.cookies.set(SESSION_COOKIE_KEY, session, {
      sameSite: 'strict',
      secure: true,
      expires: new Date(expires),
    })
  } catch (err) {
    console.error(err)
  }
}
---

<Layout title="Gradebooks | GradeGrid">
  <form method="POST">
    <label>Email</label>
    <input name="email" type="email" />
    <label>Password</label>
    <input name="password" type="password" />
    <button>Sign In</button>
  </form>
</Layout>

<style>
  form {
    display: grid;
  }
</style>
